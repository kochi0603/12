<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WebRTC+Labowork</title>
	<script type="text/javascript" src="js/jquery/jquery-3.3.1.js"></script>
	<!-- Bootstrap -->
	<script type="text/javascript" src="js/bootstrap4/bootstrap.js"></script>
	<link rel="stylesheet" href="js/bootstrap4/bootstrap.css">
	<!-- QR code 順番を変更しない事 -->
	<script type="text/javascript" src="js/qrcode/grid.js"></script>
	<script type="text/javascript" src="js/qrcode/version.js"></script>
	<script type="text/javascript" src="js/qrcode/detector.js"></script>
	<script type="text/javascript" src="js/qrcode/formatinf.js"></script>
	<script type="text/javascript" src="js/qrcode/errorlevel.js"></script>
	<script type="text/javascript" src="js/qrcode/bitmat.js"></script>
	<script type="text/javascript" src="js/qrcode/datablock.js"></script>
	<script type="text/javascript" src="js/qrcode/bmparser.js"></script>
	<script type="text/javascript" src="js/qrcode/datamask.js"></script>
	<script type="text/javascript" src="js/qrcode/rsdecoder.js"></script>
	<script type="text/javascript" src="js/qrcode/gf256poly.js"></script>
	<script type="text/javascript" src="js/qrcode/gf256.js"></script>
	<script type="text/javascript" src="js/qrcode/decoder.js"></script>
	<script type="text/javascript" src="js/qrcode/qrcode.js"></script>
	<script type="text/javascript" src="js/qrcode/findpat.js"></script>
	<script type="text/javascript" src="js/qrcode/alignpat.js"></script>
	<script type="text/javascript" src="js/qrcode/databr.js"></script>
	<script type="text/javascript">
<!--
	/*
	* ログ出力する
	*/
	function outputLog(msg) {
		console.log( msg );
		$('#logarea').append( msg + "\n" );
		$("#logarea").scrollTop( $("#logarea")[0].scrollHeight );
	}

	/*
	* Deviceリストをプルダウンに入れる
	*/
	function getDeviceList(){
		// 空っぽにする
	 	$("#camera_list").empty();
	 	let counter = 0;
	 	// カメラ、オーディオ等のデバイスリストを取得する
		navigator.mediaDevices.enumerateDevices().then( function( devices ) {
			devices.forEach( function( dev ) {
				// outputLog( dev.kind + ":" + dev.label + ":" + dev.deviceId );
				// デバイスの種類がビデオのみプルダウンに入れる
				if ( dev.kind === 'videoinput' ) {
				 	counter += 1;
		 			//$("#camera_list").append( 
		 			//	//$('<option>').val( dev.deviceId ).text( dev.label + '(' + dev.deviceId.toString().substr(0 ,10) + ')' )
		 			//	$('<option>').val( dev.deviceId ).text( dev.label + '(' + counter + ')' )
		 			//);
		 			var name = 'Camera';
	 				if ( dev.label ){
	 					name = dev.label;
		 			};
		 			$("#camera_list2").append( 
		 				$('<button type="button">').val( dev.deviceId ).text( name + '(' + counter + ')' ).attr("class","btn btn-secondary")
		 			);
				}
			});
		}).catch(function(err) {
			console.error('ERROR:', err);
		});
	}

	/*
	* ビデオを開始する
	*/
	function startVideo() {
		outputLog('Start Video');
		// 選択されているデバイス(プルダウン)の取得
		var deviceId = $("#camera_list2").val();
		outputLog(deviceId);
		// 使用するデバイスを指定する
		var constraints = {
			video: { deviceId: deviceId }
		};
		// ビデオストリームをDOMに紐付け
		navigator.mediaDevices.getUserMedia( constraints ).then( function( stream ) {
			$('#video1').get(0).srcObject = stream;
		}).catch(function(err){
			console.error('Err:', err);
		});
	}

	/*
	* ビデオを停止する
	*/
	function stopVideo() {
		outputLog('Stop Video');
		// ビデオストリームを止める
		$('#video1').get(0).pause();
		$('#video1').get(0).srcObject = null;
		// ビデオストリームが止まってない時丁寧に止める
		if ( $('#video1').get(0).srcObject ) {
			var tracks = $('#video1').get(0).srcObject.getTracks();
			if (! tracks) {
				console.warn('NO tracks');
			} else {
				for (index in tracks) {
					tracks[index].stop();
				}
			}
			$('#video1').get(0).srcObject = null;
		}
	}

	/*
	* QRコードを解読する
	*/
	function decodeQR(){
		outputLog('capture');
		if( $('#video1').get(0).srcObject ) {
			imageCapture = new ImageCapture( $('#video1').get(0).srcObject.getVideoTracks()[0] );
			imageCapture.takePhoto().then( blob => createImageBitmap( blob ) )
				.then( function(imgObj){
						//outputLog($('#canvas1').get(0).width);
						w = $('#canvas1').get(0).width;
						h = $('#canvas1').get(0).height;
						var ratio = Math.min( w / imgObj.width, h / imgObj.height );
						$('#canvas1').get(0).getContext('2d').clearRect( 0, 0, w, h );
						$('#canvas1').get(0).getContext('2d').drawImage( imgObj, 0, 0, imgObj.width * ratio, imgObj.height * ratio );
						qrcode.callback = function( result ) {
							outputLog( result );
						};
						qrcode.decode( $('#canvas1').get(0).toDataURL('image/png'));
					});
		}
	};

	$(document).ready(function(){
		getDeviceList();
	});
-->
</script>
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-12">
			<div id="camera_list2" class="btn-group" role="group"></div>
		</div>
	</div>
	<div class="row">
		<div class="col-5 col-offset-1">
			<button id="start_button"  class="btn btn-primary btn-block" onclick="startVideo()">Start</button>
		</div>
		<div class="col-5 col-offset-1">
			<button id="stop_button"   class="btn btn-primary btn-block" onclick="stopVideo()">Stop</button>
		</div>
	</div>
	<div class="row">
		<div class="col-12">
			<video  id="video1"  width="400px" height="300px" class="form-control" autoplay="1" onclick="decodeQR()"></video>
		</div>
	</div>
	<div class="row">
		<div class="col-12">
			<textarea id="logarea" rows=6 class="form-control"></textarea>
		</div>
	</div>
	<div class="row" id="test">
		<div class="col-12">
			<canvas id="canvas1" width="400px" height="300px" class="form-control"></canvas>
		</div>
	</div>
</div>
</body>
</html>
